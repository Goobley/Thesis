\chapter{Time-Dependent Radiative Transfer}\label{Chap:TimeDepRt}
%TC:group pycode 0 0
\setpythontexautoprint{false}
\begin{pycode}[TimeDepRT]
name = 'TimeDepRT'
chRT = texfigure.Manager(
    pytex,
    './02TimeDepRT',
    number=2,
    python_dir='./02TimeDepRT/python',
    fig_dir=   './02TimeDepRT/Figs',
    data_dir=  './Data/02TimeDepRT'
)
\end{pycode}

% \begin{pycode}[TimeDepRT]
% from lightweaver.fal import Falc82
% from lightweaver.rh_atoms import H_6_atom, C_atom, O_atom, Si_atom, Al_atom, CaII_atom, Fe_atom, He_atom, MgII_atom, N_atom, Na_atom, S_atom
% import lightweaver as lw
% import matplotlib.pyplot as plt
% import numpy as np

% def iterate_ctx(ctx, Nscatter=3, NmaxIter=500):
%     for i in range(NmaxIter):
%         dJ = ctx.formal_sol_gamma_matrices()
%         # NOTE(cmo): Do some initial iterations without touching the
%         # populations to lambda iterate the background scattering terms
%         if i < Nscatter:
%             continue
%         delta = ctx.stat_equil()

%         # NOTE(cmo): Check convergence
%         if dJ < 3e-3 and delta < 1e-3:
%             print('Iterations taken: %d' % (i+1))
%             print('-'*60)
%             return

% wave = np.linspace(853.9444, 854.9444, 1001)
% def synth_8542(atmos, conserve, useNe):
%     # NOTE(cmo): Configure the Gauss-Legendre angular quadrature for 5 rays
%     atmos.quadrature(5)

%     # NOTE(cmo): Construct the RadiativeSet with the following atomic models
%     aSet = lw.RadiativeSet([H_6_atom(), C_atom(), O_atom(), Si_atom(), Al_atom(), CaII_atom(),
%                             Fe_atom(), He_atom(), MgII_atom(), N_atom(), Na_atom(), S_atom()])
%     # NOTE(cmo): Set Hydrogen and Calcium to active
%     aSet.set_active('H', 'Ca')
%     # NOTE(cmo): Compute the SpectrumConfiguration for this RadiativeSet
%     spect = aSet.compute_wavelength_grid()

%     # NOTE(cmo): If we're using the electron density provided with FAL C, then
%     # compute the associated LTE populations, otherwise find a solution for
%     # self consistent LTE populations and electron density.
%     if useNe:
%         eqPops = aSet.compute_eq_pops(atmos)
%     else:
%         eqPops = aSet.iterate_lte_ne_eq_pops(atmos)

%     # NOTE(cmo): Construct the Context, optionally setting chargeConservation and the number of threads to use.
%     ctx = lw.Context(atmos, spect, eqPops, conserveCharge=conserve, Nthreads=8)

%     # NOTE(cmo): Iterate the NLTE problem to convergence
%     iterate_ctx(ctx)
%     # NOTE(cmo): Compute a detailed solution to Ca II 8542 on the 1 nm wavelength grid above
%     Iwave = ctx.compute_rays(wave, [1.0], stokes=False)
%     return Iwave

% # NOTE(cmo): Load an atmosphere. In this case we include a copy of FAL C, but
% # Lightweaver also supports loading atmospheres in the MULTI format, and it is
% # also simple to do so from the raw data components
% atmosRef = Falc82()
% # NOTE(cmo): Ca II 8542 with the reference electron density in the FAL C atmosphere
% IwaveRef = synth_8542(atmosRef, conserve=False, useNe=True)

% atmosCons = Falc82()
% # NOTE(cmo): Ca II 8542 with the electron density obtained from charge conservation
% IwaveCons = synth_8542(atmosCons, conserve=True, useNe=False)

% atmosLte = Falc82()
% # NOTE(cmo): Ca II 8542 with LTE electron density
% IwaveLte = synth_8542(atmosLte, conserve=False, useNe=False)

% fig = plt.figure()
% plt.plot(wave, IwaveRef, label='Reference')
% plt.plot(wave, IwaveCons, '--', label='Conserved')
% plt.plot(wave, IwaveLte, '--', label='LTE')
% plt.title(r'Comparison of Ca\,\textsc{ii} 854.2\,nm with different electron densities', y=1.04)
% plt.ylabel(r'Intensity [SI]')
% plt.xlabel(r'$\lambda$ [nm]')
% plt.legend()
% lFig = chRT.save_figure('EleDensComparison', fig, fext='.pgf')
% lFig.caption = r'Comparison of Ca\,\textsc{ii} 854.2\,nm with different electron densities'
% \end{pycode}
% \setpythontexautoprint{false}

% \py[TimeDepRT]|chRT.get_figure('EleDensComparison')|

% \begin{itemize}
%     \item Current problems not solved by RADYN and MS\_RADYN.
%     \item \Lw{}
%     \item \MsLw{}
%     \item Reprocessing RADYN simulations
%     \item Effect of the Lyman lines on \CaLine{} in RHD simulations
%     \item Diagnostic potential of response functions
%     \item Another item - PRD is hard?
% \end{itemize}

Modern Radiation Hydrodynamic (RHD) codes are highly complex, and contain many specialised features as discussed in the previous chapter.
In the following discussion we will focus primarily on \Radyn{}, the most widely used code of its ilk, and how using additional tools can facilitate new avenues of investigation.

\TODO{Explicit vs implicit}

\TODO{2 subcomponents}

\section{Introduction to Hydrodynamics and Conservation Laws}
\emph{The majority of the basic theory in this section follows the two texts by Leveque \NeedRef{}}

In the previous chapter we have explained the basis of the radiative transfer methods used throughout this work.
The difficulty in radiative transfer primarily lies in the nuance of the various integration terms.
To provide a clear understanding of RHD we also need a description of hydrodynamics, and thus how to solve the coupled systems of partial differential equations (PDE) that represent the other major facet of RHD.

The scalar radiative transfer equation, solved via the formal solver, presented in the previous chapter is a good example of an ordinary differential equation.
It is relatively easy to solve via a variety of methods, typically striving for a balance of speed, reliability, and accuracy.
In general, PDEs are difficult to solve numerically in a general way.

A generic PDE of a quantity $q$ depending on two independent variables $x$ and $y$ can be written as
\begin{equation}
    aq_{xx} + bq_{xy} + cq_{yy} + dq_x + eq_y + fq = g.
\end{equation}
The sign of the discriminant ($\Delta = b^2-4ac$) of this equation determines the class of the problem.
\begin{itemize}
    \item $\Delta < 0$: Elliptic problem (e.g. Poisson equation).
    \item $\Delta = 0$: Parabolic problem (e.g. Heat equation).
    \item $\Delta > 0$: Hyperbolic problem (e.g. Advection equation).
\end{itemize}
Here, we will focus primarily on hyperbolic problems, with a brief discussion of parabolic terms.
Hyperbolic problems take the form
\begin{equation}\label{Eq:ConsLaw}
    q_t + f(q)_x = 0,
\end{equation}
where $f$ is a function describing the the flux of $q$ at each location in the domain.
There is an inherent assumption that the flux function is local, and act only on the local state variables $q$.

Equations of the form \eqref{Eq:ConsLaw} are known as conservation laws, and the quantities $q$ are often termed ``conserved quantities'', implying that $\int_{-\infty}^{\infty} q\, dx$ is constant.
This does not preclude the addition of sources and sinks of this quantity, but simply requires that the total of a conserved quantity not change \emph{without} being acted on in such a way.
The simplest equation of this form is advection, which simply arises from conservation of mass in a moving fluid and is written for mass density $\rho$ and velocity $u$ as
\begin{equation}\label{Eq:Advection}
    \rho_t + (\rho u)_x = 0.
\end{equation}

The advection equation can be augmented with two further equations to form the Euler equation set.
These three equations are the conservation of mass, momentum, and energy.
Together they describe the evolution of ideal fluids.
The complete set is written
\begin{equation}\label{Eq:EulerEqns}
\begin{split}
    \rho_t + (\rho u)_x &= 0,\\
    (\rho u)_t + (\rho u^2 + p)_x &= 0,\\
    E_t + (u(E + p))_x &= 0,
\end{split}
\end{equation}
where $E$ is the total energy and $p$ is the gas pressure.
As our three conserved quantities are the mass density, momentum density, and energy, the pressure must be expressed as a combination of these so as to be able to write this system in the form of \eqref{Eq:ConsLaw}.
The simplest way to achieve this is to use the equation of state for an ideal gas
\begin{equation}
    E = \frac{p}{\gamma-1} + \frac{1}{2}\rho u^2.
\end{equation}
Here $\gamma$ is the ratio of gas' specific heat at constant pressure and constant volume, which is 5/3 for monatomic gasses, as considered in the case of solar plasma.

The Euler equations \eqref{Eq:EulerEqns} describe evolution of an ideal fluid without any losses.
In practice we often need to model some loss terms.
Ignoring radiative effects for now, the most important of these is heat conduction\footnote{In the plasmas considered here there is additional nuance to heat conduction, which we will return to in \TODO{sec}.}, which is typically described by parabolic equations.
This adds a second spatial derivative term to the right-hand side of the energy conservation equation.
It is also common to need source and sink terms when modelling real world problems, these can account for fluids entering and leaving a volume, the non-local emission and absorption of energy, or simply the effects of gravity.
These terms are also added to the right-hand side of the equations of \eqref{Eq:EulerEqns}, and together with the effects of viscosity, these describe the Navier-Stokes equations.

\subsection{Numerical Approaches}

The typical first choice for numerically solving differential equations is to apply a finite difference method.
In this class of method, the problem is discretised, similarly to the approach taken in radiative transfer, and the values associated with each grid point represent the local pointwise value.
The local gradient of the conserved quantities can then be estimated from pointwise difference between in the quantity between adjacent cells.
This method can be applied to discrete problems in both space and time.
Applying a basic one-sided method to the advection equation \eqref{Eq:Advection} gives
\begin{equation}\label{Eq:FdmAdvection}
    \frac{q^{t+1}_i - q^t_i}{\Delta t} + u\left( \frac{q^t_{i+1} - q^t_i}{\Delta x} \right),
\end{equation}
where the subscript refers to the location of the conserved quantity, the superscript the discrete timestep, with $\Delta x$ and $\Delta t$ being the local grid spacing and timestep duration respectively.

It is clear that without loss of generality we could have also chosen to spatially difference our problem in the other direction (i.e. $q^t_i - q^t_{i-1}$).
From the infinitesimal definition of the derivative, these two formulations are equivalent.
This is not the case in discretised problems.
It is better to locally use the formulation such that information from points ``upwind'' in terms of the fluid velocity are used to update the points downwind of themselves.
In this sense the information used to update points is following the fluid flow.
Equation \eqref{Eq:FdmAdvection} can be rewritten to explicitly determine the approximate value of the quantity at the next timestep,
\begin{equation}
    q^{t+1}_i {\Delta t} = q^t_i - \frac{u \Delta t}{\Delta x}\left( q^t_{i+1} - q^t_i \right).
\end{equation}

This simple first order accurate approach can be applied to any conservation law, and higher-order accurate methods can be derived from using finite difference methods over larger stencils, or deriving similar approaches from combinations of the local finite difference approximations using Taylor series.

Many other spatial and temporal discretisations can be devised for conservation laws, and it is important to choose a discretisation that introduces minimal error.
In general, we term discretisations where $q^{t+1}$ depends only on $q^{t}$ as \emph{explicit}, and those also depending on $q^{t+1}$ as \emph{implicit}, necessitating the solution of a system of typically non-linear equations.

Whilst the finite difference method provides an intuitive formulation for discretising these equations, it is difficult to ensure conservation of the quantities that we desire be conserved with only pointwise values and no formal description of the variation between these points.
Instead the finite volume description is often preferable and consists of treating $q_i^t$ as the average value over a grid cell,
Conservation can then be ensured by evolving this value based on the fluxes in and out of the cell.
This implies
\begin{equation}
    q_i^t \approx \frac{1}{\Delta x}\int_{x_i}^{x_{i+1}} q^t(x)\, dx.
\end{equation}
Rewriting the conservation law \eqref{Eq:ConsLaw} in an integral form then gives
\begin{equation}
    \int_{x_i}^{x_{i+1}} q^{t+1}(x)\, dx = \int_{x_i}^{x_{i+1}} q^{t}(x)\, dx
                                         + \int_{t_t}^{t_{t+1}} q_i(t)\, dt
                                         - \int_{t_t}^{t_{t+1}} q_{i+1}(t)\, dt,
\end{equation}
which can then be written as the flux-differencing form
\begin{equation}\label{Eq:FiniteVolumeMethod}
    q_i^{t+1} = q_i^t - \frac{\Delta t}{\Delta x}\left( F^t_{i+1} - F^t_{i} \right),
\end{equation}
where $F_i$ represents the flux due between cells $i$ and $i-1$, and $F_{i+1}$ the flux between cells $i$ and $i+1$.
In the case of an explicit method with a correctly chosen timestep for the grid, where information cannot move further than one cell in a timestep, each of these flux functions depends only on cell $i$ and one of its neighbours.
An important strength of this method for solving conservation law problems is that if $F_i$ and $F_{i+1}$ are respectively the left and right edge fluxes for cell $i$, then $F_{i+1}$ will be the left edge flux for cell $i+1$, and $F_{i}$ will be the right edge flux for cell $i-1$.
Thus the numerical integration of $q^{t+1}$ is conserved with respect to $q^t$ as all numerical fluxes, other than the left- and right-most, will cancel due to the formulation of \eqref{Eq:FiniteVolumeMethod}.
These left- and right-most fluxes will need to consider the boundary conditions of the finite simulation volume to ensure the correctness of the conservation law.


\subsection{Riemann Problems}

% spell-checker: disable
\begin{pycode}[TimeDepRT]
from shocktubecalc import sod
from matplotlib.ticker import MaxNLocator

gamma = 1.4
positions, regions, values = sod.solve(left_state=(1.0, 1.0, 0.0), right_state=(0.1, 0.125, 0.0),
                                       geometry=(0.0, 1.0, 0.5), t=0.2, gamma=gamma, npts=500)
fig, ax = plt.subplots(2, 2, figsize=texfigure.figsize(pytex, scale=1, height_ratio=0.6),
                       constrained_layout=True)
ax = ax.ravel()
grid = values['x']
pressure = values['p']
density = values['rho']
velocity = values['u']
totE = pressure / (gamma - 1.0) + 0.5 * density * velocity**2

ax[0].plot(grid, density)
ax[0].set_xticklabels([])
ax[1].plot(grid, velocity)
ax[1].set_xticklabels([])
ax[2].plot(grid, pressure)
ax[3].plot(grid, totE)

ax[0].set_ylabel(r'$\rho$')
ax[1].set_ylabel(r'$u$')
ax[2].set_ylabel(r'$p$')
ax[3].set_ylabel(r'$E$')

ax[2].set_xlabel(r'$x$')
ax[3].set_xlabel(r'$x$')

lFig = chRT.save_figure('SodTubeAnalytic', fig, fext='.pgf')
lFig.caption = r'Solution to the classic Sod shock tube problem at $t=\SI{0.2}{\second}$.'

fig = plt.figure(figsize=texfigure.figsize(pytex, scale=1, height_ratio=0.55))
ax = plt.gca()
ax.plot(grid, density)
ax.set_ylabel(r'$\rho$', c='C0')
ax.set_xlabel(r'$x$')

ax2 = ax.twinx()
# ax2.plot([0.5, 0.7], [0, 0.2], c='#222222')
for i, p in enumerate(positions.values()):
    ax2.axvline(p, c='k')
    if i != 1:
        ax2.plot([0.5, p], [0, 0.2], c='#555555')
regionLims = np.array([0, *positions.values(), 1])
regionCentres = 0.5 * (regionLims[1:] + regionLims[:-1])
labels = [r'$\alpha$', r'$\beta$', r'$\gamma$', r'$\delta$', r'$\epsilon$']
for i, c in enumerate(regionCentres):
    ax2.text(c, 0.02, labels[i])

ax2.set_ylabel(r'$t$')
ax2.yaxis.set_major_locator(MaxNLocator(5))
lFig = chRT.save_figure('RiemannFan', fig, fext='.pgf')
lFig.caption = r'Riemann fan of different wave speeds and associated regions for the Sod shock tube problem.'
\end{pycode}

\py[TimeDepRT]|chRT.get_figure('SodTubeAnalytic')|
\py[TimeDepRT]|chRT.get_figure('RiemannFan')|
% spell-checker: enable

The finite volume method we have described therefore depends on finding expressions for the numerical flux between two adjacent cells.
This is often framed as a Riemann problem at the cell interface.
A Riemann problem consists of solving a conservation law with an initial parameter distribution consisting of two constant states meeting at a discontinuity.
Without loss of generality this discontinuity can be placed at $x=0$, and the value of $q$ for $x<0$ is termed $q_l$ and $q_r$ for $x>0$.

A very well studied Riemann problem, that is often used as a test case for numerical hydrodynamics is that of the Sod shock tube \citep{Sod1978}.
The problem is a single Riemann problem, with gas at a different pressure and density on each side of a membrane.
At $t=0$ the membrane is removed, and multiple waves with different velocities are launched in both directions.
A solution to the classic Sod shock tube with states $q_l = \{\rho=1, p=1, u=0\}, q_r = \{\rho=0.125, p=0.1, u=0\}$ at $t=\SI{0.2}{\second}$ is shown in Fig.~\ref{Fig:SodTubeAnalytic}.
At this time, a complex pressure and density structure has formed in the shock tube.
It often best to look at the Riemann problem in terms of the propagating waves.
In Fig.~\ref{Fig:RiemannFan} we show the same density profile, but divided into regions by black lines, with grey lines showing a time-distance plot of the different waves in the system.
This plot, and manner of considering the waves in the system is known as a Riemann fan.

The left- and right-most regions of density ($\alpha$ and $\epsilon$) shown in Fig.~\ref{Fig:RiemannFan}, are simply the initial left and right states of the fluid, as these are currently unperturbed by the waves propagating from the initial discontinuity.
Starting from the initial discontinuity, a rarefaction wave (reduction in density) moves into the high density region (to the left), and a shock wave propagates into the low density region (to the right).
The rarefaction wave is present in region $\beta$, with the shock front being the boundary between $\delta$ and $\epsilon$.
There is an additional front between regions $\beta$ and $\gamma$, which we note is not visible on either the velocity or pressure panels of Fig.~\ref{Fig:SodTubeAnalytic}.
This is a contact discontinuity and represents the boundary between two regions of different entropy.
This is the original interface between the two gases at $t=0$, and it is advected along with the flow at the velocity $u$, so there is no mixing between the two sides of this contact discontinuity (in the case of an ideal gas).

From analysis of the Jacobian of the flux function of the Euler equations, the structure of this solution can be revealed.
There are three waves, associated with the eigenvalues of this Jacobian.
The contact discontinuity propagates at the fluid velocity $u$ (as the fluid expands into the low density region), the other two eigenvalues are $u\pm c_s$, where $c_s$ is the sound speed of the fluid.
Unfortunately these waves are non-linear and do not necessarily propagate at the characteristic velocity given by their associated eigenvalue.
Instead it is necessary to apply the Rankine-Hugoniot jump conditions, at both the shock front and the contact discontinuity (given that the pressure and velocity do not vary across the latter), and solve the resultant transcendental equation to determine the parameters of regions $\gamma$ and $\delta$.
These problems can be solved using iterative methods and knowledge of the expected wave form of the solution.

As the complexity of the system and the equation of state increases, it becomes harder (or impossible) to compute this solution in an efficient manner.
Fortunately, it is rarely necessary to compute the exact solution to the Riemann problem, but it is important to understand the the structure originating from this simple case to interpret and validate the numerical methods described later.

% N.B. The characteristic of a system like this is a line for which the the solution q is constant. i.e. for advection this is x(t) = x0 + ut
% For linear systems we can transform to characteristic variables, for which the coefficient matrix is diagonal and we have a system of independent scalar advection equations.
% The velocity is time/space varying along the rarefaction wave.
% The characteristic field of an equation is an eigenvector, if this is linearly
% degenerate then we can only have contact discontinuities.
% Integral curves are curves which connect two points by an integral of one of the eigenvectors of the system.
% A function of q that is invariant along any integral curve is called a Riemann invariant, these are used for solving problems related to rarefaction waves.
% These Riemann invariants are conserved along the characteristic. For the u eigenvector, we have u and p as invariant, hence only the pressure can change => contact discontinuity.
% Characteristics on each side of shock linked by Hugoniot locus

\subsection{Godunov's Method and Higher Order Reconstructions}

Godunov's method \citep{Godunov1959} consists of assuming that the data $q$ is piecewise constant in each cell of our simulation domain.
At this point the values on the left- and right-hand side of each interface are known and the flux through this interface can be determined by solving a Riemann problem.
The Riemann problem at each interface can be treated independently under the assumption that the fastest wave from one interface not carry information to the next.
This is a fundamental requirement of stability and will be discussed in more detail in Sec.~\ref{Sec:HydroStability}.

This method provides a basic framework for solving conservation laws.
It is limited by the assumption that the data is piecewise constant, but nevertheless paved the way for the some of the most accurate numerical methods for conservation laws.
\citet{VanLeer1979} provided one of the first higher order extension to Godunov's method.
It is tempting to attempt to estimate the value of $q$ at cell interfaces with higher accuracy by using some form of reconstruction (a method closely related to interpolation), but care must be taken with this approach.
The MUSCL method of \citet{VanLeer1979} uses a piecewise linear approach to reconstruction in each grid cell, but limits the gradient of the reconstruction to prevent the addition of under or overshoots to the data.
This is achieved through use of a slope-limiter such that a monotonic series of cell averages be preserved by ensuring that the reconstructed slope not take values beyond the average of the adjacent cells.
If the current cell is an extremum then the slope is set to 0.
Different slope-limiters have been designed and present different trade-offs in terms of accuracy in smooth regions against the risk of introducing spurious oscillations in the solution, these are discussed at length in introductory texts, such as Leveque \NeedRef{}.
This method tracks the data to second-order in regions of smooth variation, but degenerates to the first-order Godunov method at discontinuities.

There are further high-order extensions to the concept of reconstruction including the parabolic method of \citet{Colella1984}, providing third-order accuracy in smooth regions, and the general weighted essentially non-oscillatory (WENO) methods.
WENO methods are a cornerstone of reconstruction\footnote{The properties that make WENO methods a good choice for reconstruction also render them applicable to interpolation. Throughout \Lw{} and the other numerical tools presented in this thesis we make use of a fourth-order WENO interpolation method described by \citet{Janett2019} for its accuracy in smoothly varying regions and reliable behaviour around sharp variations.} in modern finite volume codes, and as such we will describe them briefly here.

WENO methods were first proposed by \citet{Liu1994}, and formalised for arbitrary order by \citet{Jiang1996}.
These methods form a convex combination of interpolating polynomials over overlapping regions.
For example, in the case of the commonly used fifth-order WENO method of \citet{Jiang1996}, three parabolae are constructed over five adjacent points, i.e. the first uses the stencil $\{x_1, x_2, x_3\}$ the second $\{x_2, x_3, x_4\}$, and the third $\{x_3, x_4, x_5\}$.
We can equivalently define a fifth-order polynomial over the stencil $\{x_1, \ldots, x_5\}$, which can also be written as a linear combination of our interpolating parabolae at each point in this region.
These linear weights can be further weighted by a term known as the \emph{smoothness indicator}, which estimates the local smoothness, such that the weight of each term is equal to its expected linear weight in smooth regions, and heavily biased towards a parabola in a smooth region if other regions present discontinuities or similar effects.

The process of computing these initial interpolating functions is somewhat complex due to the finite volume framework often applied in hydrodynamics.
These should be computed such that the integral over the interpolating polynomial in each cell is close to the average value, rather than simply taking it as a pointwise value.
For a fixed uniform grid, the integration weights for each interface can be computed analytically, and the lack of conditional branches in the calculation of the final weighted value renders the method highly performant.
For non-uniform grids, the weights can be precalculated if the grid remains fixed, or computed on the fly if necessary.
There are also a number of approximate methods for handling non-uniform grids at low computational cost such as WENO-NM \citep{Huang2018}.
The WENO method has been extended many times to provide increased accuracy or meet certain requirements, its strong reconstructive ability, and reliable behaviour around shocks makes it a workhorse of modern hydrodynamics and enables simpler flux functions to be reliably used, as will be discussed in the next section.


\subsection{Numerical Fluxes}

Whilst there are many approximate Riemann solvers that can accurately and efficiently solve the Riemann problems arising from the Euler equations including the addition of source terms, it does not appear feasible to express the evolution of the RHD system in this way.
Instead, in explicit methods we use numerical approximations to the flux based on the reconstructed values at the interfaces is used.
For implicit methods we can instead use a Newton iterative scheme to minimise the residual of the discretised conservation law across the cell interfaces with the fluxes typically computed from the upwind value of the reconstructed parameter.

With high-order reconstructions, simple expressions for the fluxes can be used and give accurate results.
An obvious first choice would be the average flux from the reconstructed states left and right of the interface.
Unfortunately, this leads to numerical instabilities, and some artificial damping (numerical viscosity) is needed.
This leads to a flux known as the Local Lax-Friedrichs, or Rusanov Flux \citep{Rusanov1962}
\begin{equation}
    F_{\mathrm{LLF}} = \frac{1}{2}(f(q_{i+1}^L) + f(q_i^R)) - \frac{1}{2}\alpha(q_i^R - q_{i+1}^L).
\end{equation}
Here $q_i^L$ and $q_i^R$ represent the left and right hand reconstructed states of the $i$-th Riemann problem, $f$ represents the flux function of the conservation law, and $\alpha$ is the local maximum wave propagation speed for this system.
Whilst $\alpha$ can often be formally derived from the Jacobian of $f$, it can often be replaced with either the maximum absolute value of the sum of the sound speed on each side of the interface and the local fluid velocity, or the average of these on both sides of the interface.
General symmetric fluxes like this are simple, and efficient but tend to be diffusive, smearing features across many grid cells, especially if the first-order Godunov or van Leer-style reconstruction methods are used.
This effect can be effectively combatted by the use of high-order reconstruction schemes and adaptive mesh refinement techniques, although when available a specialised Riemann solver for the current problem is likely a better choice.

\subsection{Time Integration and Stability}\label{Sec:HydroStability}

Explicit schemes are only stable (i.e. do not diverge or introduce spurious oscillations) if the Courant-Friedrichs-Lewy (CFL) condition is met.
The CFL condition states that the numerical domain of dependence of the the equation (i.e. the terms used in the computation of the method) must encompass the analytic domain of dependence to ensure that all necessary information is taken into account.
This is a necessary, but not sufficient condition, and the exact requirements of each scheme can sometimes be derived analytically, although it is common to simply apply a safety margin to the maximum permitted value of the CFL condition.

For explicit methods the CFL condition sets the maximum timestep that can be used based on the current simulation conditions.
In a hyperbolic system the CFL condition takes the form
\begin{equation}
    C = \frac{u\Delta t}{\Delta x},
\end{equation}
and will be constrained to a maximum value ($\leq 1$) for stability of an explicit method.
Most implicit methods do not place an upper limit on the CFL condition for stability (as all points are coupled), but typically need to remain $\sim 1$ to avoid losing fine detail in the solution.
This is discussed \citet{Viallet2011}, who comment that CFL $\sim 1$ serves as an accuracy criterion and typically represents the optimum accuracy/computational cost despite the method being nominally stable for large CFL values.

It is difficult to achieve better than second order accuracy due to the temporal discretisations discussed so far, but by viewing $F_i^t$ as the flux at time $t$, we can achieve higher order accuracy by applying a multi-step method to more accurately integrate these fluxes (and any associated source terms) over time.
A good choice for this is a method in the family of total-variation diminishing Runge-Kutta methods \citep[e.g.][]{Shu1988}.
These multi-step time integration methods can be combined with fractional step methods that allow us to perform \emph{operator splitting}.
That is, splitting an equation into two subproblems that can solved independently.
An example of this would be the radioactive decay of an isotope transported by advection.
Splitting this into an advection and a reaction problem allows for standard methods to be used in both of these problems, but clearly their results need to be coupled to each other.
A naive first approach is to solve one of the subproblems over the timestep, and then solve the other, but this method cannot be better than first order accurate in time for coupled subproblems.
A commonly used approach that is second order is known at Strang splitting \citep{Strang1968}, which consists of time-advancing the first subproblem by half the timestep, then the second by the whole timestep, before once again advancing the first subproblem by a timestep.
This method can provide second-order accuracy.
Many more advanced splitting procedures have been developed, but Strang splitting remains widely used due to its ease of implementation.

LeVeque \NeedRef{} comments that in many situations the first-order splitting described above performs better than would be commonly expected from its formal first-order accuracy.
This is because the errors introduced are equivalent to solving the problem at a slightly different time, differing by up to a single timestep.
Whilst this renders the method first-order accurate, the quality of the solution is still primarily controlled by the quality of the methods used to solve the subproblems, and this exceedingly simple splitting scheme can often be applied with no problems.

There are many nuances to each of the techniques needed to accurately and robustly solve conservation laws numerically, and no single \emph{correct} method to use.
The above is intended to serve as an introduction to the complexities of these methods, but by no means present a conclusion on how conservation laws should be solved.
It is hoped that this introduction will improve general understanding of this aspect of RHD codes.

\section{Conduction}

When expressed in terms of energy the heat equation in a plasma along a magnetic field line is given by
\begin{equation}
    \frac{\partial E}{\partial t} = \frac{\partial}{\partial z}\left( \kappa_0 T^{5/2} \frac{\partial T}{\partial z} \right),
\end{equation}
with spatial coordinate $z$, and coefficient $\kappa_0$ varying, but typically taken to be approximately \SI{1e-6}{\erg\per\centi\metre\per\second\per\kelvin\tothe{7/2}} \citep{Spitzer1953,Braginskii1965}, based on deviations from a fully ionised hydrogen plasma.
The form of this equation poses several problems, the most significant being that in regions of sufficiently steep temperature gradients, the conductive flux approaches infinity.
Clearly this is not physical and there is a maximum limit, known as the free-streaming limit at which all electrons in the plasma are flowing at their thermal speed with this heat gradient, representing a finite limit on this term.
As this free-streaming limit is approached the heat flux becomes non-local and depends on the global temperature and density structure in the loop \citep{Battaglia2009}.
\citet{Campbell1984} provides an expression for the transport coefficients used to determine the conductive flux through an ionised plasma and smoothly handles both the Spitzer-H\"{a}rm, locally limited, and non-locally limited regimes.
This approach can be applied in numerical simulations but more frequently (such as in RADYN) the method of \citet{FISHER1985} is applied which smoothly limits the local flux to remain less than the local free-streaming limit, hence helping to stabilise this equation.

Due to its parabolic nature, an explicit solution of the heat equation can be extremely costly; stability requirements provide a timestep requirement scaling with the square of the grid spacing, rather than linearly as in the case of most hyperbolic equations.
Any attempt to explicitly integrate the heat equation on a timestep limit set by the hydrodynamic equations will likely be met with rapid divergence of any small perturbation in the data.
This renders the conduction term stiff compared to the hydrodynamical terms and it may therefore be advantageous to use an implicit method  to guarantee stability.
Several alternative methods have been developed, such as expressing the parabolic equation as a hyperbolic wave equation \citep{Rempel2016}, implicit-explicit methods (which may also be used for integrating stiff source terms such as the atomic level population transition rates) \citep[e.g.][]{Ascher1995}, or accepting the cost of an explicit discretisation in exchange for simplicity and accuracy \citep{Bradshaw2003, Bradshaw2013}.

Recently, discussion has emerged around the concept of turbulence suppressed conduction \citep{Bian2016}, where turbulence restricts the motion of electrons along the loop, and it has been suggested that the standard assumption of collisionally-dominated conduction may represent a significant overestimation of true conduction rates.
Simulations using the zero-dimensional enthalpy based EBTEL code currently suggest that this turbulent suppression alone is insufficient to maintain the high coronal temperatures and slow cooling times seen in observations, but likely represents an important component of this effect \citep{Bian2018}.
As part of further investigation, work is currently under way to integrate these effects in the \Radyn{} and HYDRAD codes.

\section{A Brief Dissection of \Radyn{} and a Possible Future of RHD Modelling}\label{Sec:RadynDissection}

\emph{This section is informed by my discussions with Mats Carlsson, experiences using \Radyn{}, and in-depth analysis of its source code. It represents my own conclusions from the synthesis of these.}

\Radyn{}'s design closely follows its radiative transfer lineage. Its direct predecessor is the MULTI radiative transfer code and many commonalities remain.
NLTE radiative transfer is solved on a per transition basis using an ALI method and linearisation of the resultant level population balance equations.
This method is designed to solve the problem of non-overlapping lines but including an underlying background continuum.
This linearisation approach was proven by \citet{SocasNavarro1997} to be effectively equivalent to that of preconditioning for non-overlapping transitions \citep{Rybicki1991} for pure radiative transfer problems in the statistical equilibrium case.
This approach also assumed the use of a local diagonal $\Lambda^*$ operator, as discussed in the previous chapter.
\Radyn{}, however, chooses to employ a pentadiagonal $\Lambda^*$ operator to make optimal use of matrix bandwidth necessary elsewhere in the program and obtain improved convergence as a result.
It is unlikely that this change in operator significantly affects the conclusions of \citet{SocasNavarro1997}, but affects the two methods will no long arrive at the exactly equivalent numerical formulations.

The advantage of the linearisation approach in \Radyn{} is the ability to directly couple other equations to the RTE and implicitly solve all of these simultaneously and self-consistently.
Taking for example the kinetic equilibrium equation \eqref{Eq:KinEq}, \Radyn{}'s method formulates this expression such that the corrections from both the advection and population transition terms are considered simultaneously.
This is achieved through the use of a Newton-Raphson method, where the Jacobian is computed based on an analytic derivation, including the aforementioned linearisation of the kinetic equilibrium equation.
This same process simultaneously solves for the heat conduction, hydrodynamics of the system, and the new locations of the dynamic grid of \citet{Dorfi1987}.

A significant benefit of this implicit approach is a relaxation of the timestep constraints present in explicit approaches.
This is particularly important when considering the very fine grid spacing often required by the dynamic grid, which combined with the large bulk velocities occurring in flares can lead to extremely oppressive timestep constraints.

Despite its elegance, there are several major downsides to this implicit approach.
Foremost of these is the complexity engendered by the coupled design of the system, and the need to ensure that all necessary derivatives are analytically computed and included.
This presents a very large barrier to entry for future developments on the platform, and this is likely part of the reason why both Fokker-Planck modules integrated in \Radyn{} have operated externally to this core coupled system.
Additionally, implicit codes, whilst having less severe timestep constraints, are typically much more costly per timestep than explicit codes.
This is somewhat offset by the majority of the cost of each step residing within the formal solver, which remains similar in both cases.
The dynamic grid can also become problematic due its lack of interpretability, and propensity to drop to spacings finer than the local cyclotron radius in more energetic simulations.

\Radyn{} is a fantastic tool that has enabled insight into many different flare associated phenomena, and through these comments we do not intend to discredit its use, but instead highlight avenues for future development within the field of RHD.
As the different uses of \Radyn{} continue to evolve in complexity, with projects such as multi-strand arcade and minority species modelling \NeedRef{}, the code at the core of \Radyn{} will need to be modified by different researchers, and work facilitating this and highlighting additional factors to be considered in RHD modelling is core to the future development of this field.

As discussed previously in respect to \Lw{} and radiative transfer, the flexibility of a framework designed for solving a class of problem can yield significant advances in productivity.
The task of designing, constructing, and testing such a framework for a problem such as the complete quasi-one-dimensional RHD simulation flares is too significant to be undertaken here.
Nevertheless, it may prove a convenient future development once the necessary specifications are defined.
Here, we focus on reprocessing aspects of the radiative transfer of previously computed \Radyn{} simulations and investigate important directions for future developments in RHD modelling of flares.

\section{Minority Species}

For flares, \Radyn{}'s primary focus is on the major spectral lines and continua of hydrogen, helium, and calcium.
These typically represent the bulk of the radiative energy lost in the chromosphere.
Singly ionised magnesium has also been shown to be an important contributor to these energy losses, however the h and k lines require a treatment including PRD to avoid significantly overestimating their losses.
The \Caii{} H and K lines are also somewhat affected by PRD, in addition to the hydrogen Lyman lines.
For the Lyman lines we will discuss several strategies for approximating this treatment, and for \Caii{} H and K, it has been suggested that considering these in CRD approximately accounts for the lack of Mg\,\textsc{ii} h and k if all of these transitions were treated with PRD \citep{Kerr2019a}.

Whilst the lines of these four species are some of the strongest in solar spectrum, and their continua mediate much of the energy leaving the chromosphere, there are other chromospheric transitions that can also be used to diagnose the atmosphere.
For example, Si\,\textsc{iv} optical thickness has been investigated in a minority species context by \citet{Kerr2019c}.
An element treated as a ``minority species'' is assumed to not interact significantly with the energy balance of the simulation (i.e. the thermodynamic response of the model does not change significantly if this species is subject to a complete radiative treatment).
This should be true for most species with trace populations.
The radiative transfer calculations associated with this species can then be performed in a ``second-pass'' over a previously computed \Radyn{} simulation.
The MS\_RADYN code was designed for this task; it takes the thermodynamic parameters from every timestep of a \Radyn{} simulation, along with the non-equilibrium hydrogen populations, and solves the kinetic equilibrium equation at each timestep for a minority species.
Due to the lack of atmospheric thermodynamic response to changes in the radiative output of this species, far more complex atomic models can be used, such as the 30 level model silicon atom used by \citet{Kerr2019c}.

An approach similar to that of minority species modelling can be applied to testing the methods used in \Radyn{} and the importance of certain omissions.
Due to the reduced complexity of solving the kinetic equilibrium equations rather than the entire RHD system, these calculations typically run significantly faster than the original simulation.
In the following we will discuss the creation of a minority species tool for reprocessing \Radyn{} simulations, built on the \Lw{} framework, as well as its application to investigating the importance of overlapping transitions and discussing the difficulties of including PRD in these simulations.
From the previous discussion, building such a tool on the \Lw{} framework should provide researchers with a modern, simpler codebase that is easier to conceptualise and modify, allowing for investigation of effects to be included in \Radyn{} or future RHD codes.
Excluding the model atom definitions, the source code of the simulations presented in this chapter totals $\sim$1000 lines of Python, mostly following modern best practices.

\section{Reprocessing \Radyn{} Simulations with the \Lw{} Framework}

To perform a minority species simulation, a particular file from the original simulation, \texttt{atmost.dat}, must be provided.
From investigating the contents of this file we can determine the exact configuration of \Lw{} and the equations to be solved.
This file is written to for every internal timestep of the \Radyn{} simulation, and represents a limited subset of the less frequently written ``complete'' output (typically stored every \SI{0.1}{\second}).
It contains some metadata describing the size of the simulation, then for each internal timestep, the current timestep, the elapsed time at each timestep, the current locations of the dynamic grid, the mass density profile, the electron density profile, the temperature structure, the vertical velocity, and the current hydrogen level populations.

For the validation of \Lw{} and this style of simulation, we also wished to compute and compare the hydrogen populations to those computed in \Radyn{}.
Several difficulties arose due to the non-thermal collisional rates used in the kinetic equilibrium calculation for hydrogen and helium.
The non-thermal collisional rates of \citet{1993Fang} are used to determine hydrogen ionisation, and require the beam energy deposition throughout the atmosphere at each timestep.
For helium, if the Fokker-Planck electron beam description is used, then the rates of \citet{Arnaud1985} are used, but these require integration over the electron energy distribution.
Whilst it is possible to add both of these to the \texttt{atmost.dat} file, the complete electron distribution information is very large, and we instead elect to use ``Emslie'' beam electron formalism \citep{Emslie1978}, for which the energy deposition profile throughout the atmosphere is sufficient to describe the non-thermal rates.
We therefore chose to slightly modify \Radyn{} and add the beam deposition profile to the \texttt{atmost.dat} file.
Our function for reading these files can handle both files with and without this modification.
In the event that this beam heating information is not saved, an approximation of it can be reconstructed via interpolation from the information in \Radyn{}'s complete save file.
Our testing of this show that the approximation is relatively good, but short term, or particularly narrow heating features may be lost.
For this reason, all simulations presented here use the version with this data.

With the above data we have sufficient information to construct the \Radyn{} thermodynamic atmosphere at any of its internal timesteps.
\Lw{} does not make use of the mass density directly, but instead maps it to hydrogen density.
For this we use of the default abundances in \Lw{}, based on \citet{Asplund2009}.
These differ to those used in \Radyn{}, but not significantly for any of the species discussed here.
Ignoring the advection term it is then simple to produce a minority species tool using this approach.
In many situations, the advection term has a small effect, and can safely be ignored \NeedRef{} \TODO{Old Flarix paper}.
The radiative transfer equation employed in \Radyn{} is formulated on the dynamic grid, and this is not the case in \Lw{}, which assumes that the grid is static (although this limitation can be worked around).
We can simply use a fixed denser spatial sampling of the atmosphere to account for the motion of features such as the transition region over the course of the simulation.
This model then interpolates the thermodynamic properties and NLTE hydrogen populations for the starting atmosphere onto our stratification and computes the statistical equilibrium solution for the minority species in question.
For each subsequent timestep these properties are interpolated from the new \Radyn{} grid to the static grid, and the minority species populations can be advanced in time using the process described in Sec.~\NeedRef{}.

To reduce the number of grid points needed for a static stratification one could instead use a fixed column mass stratification.
The transition region moves very little in terms of column mass during the simulation, however it then becomes necessary to interpolate the populations from one column mass stratification to the next; a process which can introduce significant error if not undertaken with care.
This error can be reduced by renormalising each specie's total number density throughout the atmosphere from the mass density and abundances, and this helps to avoid errors growing around regions of high gradient, such as the transition region.

To solve the minority species problem properly in a manner compatible with \Radyn{} it is necessary to include the advection terms.
In the following we will describe several different approaches to handling these advection terms, and thus solving the complete kinetic equilibrium equations.

\subsection{Advection}

In Sec.~\ref{Sec:RadynDissection} we discussed the coupled nature in which \Radyn{} solves the RHD equations.
For flexibility we wish to decouple the advection terms from the population transitions.
Our initial approach was to use an explicit method on the dense, fixed grid discussed above.
Explicit methods are typically simpler to validate and understand, so seemed a logical fit for this project.

\TODO{Describe WENO-HD -shocks etc}

To improve the agreement with \Radyn{}, reduce the number of interpolations,. and leverage its adaptive grid we instead decided to apply its technique for advection, but keep it distinct from the radiative transfer.
Thus, at the start of each timesteps we advect the populations from the previous grid to the new grid locations, and then advance the populations in time based on the NLTE rates.
This technique is known as operator splitting \NeedRef{}, and is commonly applied in hydrodynamics simulations where different numerical techniques are effective at solving different components of the system.
Performing a na\"{i}ve splitting like this limits the accuracy of the solution to first order accuracy in time.
Various advanced splitting techniques, such as Strang splitting \citep{Strang1968}, have been developed to reduced this error.
Strang splitting reduces these error terms to second order, and newer approaches can reduce the impact of operator splitting to fourth order in time \NeedRef{}.
A Strang splitting approach was implemented in our code using these components, but the results were not found to differ appreciably.
It is likely that this is due to one of the two processes dominating.
During explosive heating the populations in the upper chromosphere typically have very large transition rates, and comparatively slow advection.
At later times, when the timestep is longer, the transition rate is typically much lower and the plasma flows are relatively smooth, but often high velocity.

As discussed above, it is necessary to accurately and conservatively resolve shocks in advection and hydrodynamics problems, something that has been recognised since the 1950s \NeedRef{} \TODO{FCT book?}.
For this \Radyn{} employs a variant of the second order spatially accurate method of \citet{VanLeer1979}.
The concept of this class of method is similar to that of short characteristics formal solvers, ensuring that no spurious minima or maxima are injected into the solution, which in hydrodynamics would result in a gain or loss of density.

\TODO{I think we need a clear introduction to shock capturing methods. Read over pyCLAW paper and Leveque intro.}

\section{On the Importance of \Caii{} Photoionisation by the Hydrogen Lyman Lines in Flare Models}

\emph{The content of this section is based on the work presented in \Caii{} paper \NeedRef{}.}

The methods discussed above can be used to reprocess the radiative transfer aspects of \Radyn{} simulations and thus investigate the effects of \Caii{} photoionisation on these models.
In \Radyn{} the photoionisation of \Caii{} by the hydrogen Lyman continuum is considered, but the effects of the Lyman lines are not.
Fig.~\ref{Fig:CaIIOverlaps} shows the the overlap between the hydrogen Lyman transitions and the \Caii{} continua present in our model.
Radiation from Ly$\alpha$ photoionises \Caii{} from all levels other than the ground state.
All of the other Lyman transitions present can photoionise \Caii{} to \Caiii{} from all levels present in this model.
Additionally, in flaring conditions, the higher lines of the Lyman sequence are significantly Stark broadened and create a quasi-continuum between Ly$\delta$ and the Lyman continuum \citep{DeFeiter1975}, which will further enhance the photoionisation of \Caii{} from what is considered in our model.

%spell-checker: disable
\begin{pycode}[TimeDepRT]
from MsLightweaverAtoms import H_6, CaII
from matplotlib.patches import Rectangle
from weno4 import weno4

# plt.ion()
H = H_6()
Ca = CaII()
fig = plt.figure(figsize=texfigure.figsize(pytex, scale=1, height_ratio=0.55))
ax = plt.gca()

# C1 = '#EECC66'
# C2 = '#6699CC'
C1 = 'C1'
C2 = 'C0'

lineLabels = [r'Ly$\alpha$', r'Ly$\beta$', r'Ly$\gamma$', r'Ly$\delta$']
lineIdx = 0
for l in H.lines:
    if l.i != 0:
        continue
    plt.axvline(l.lambda0, c=C1)
    ha = 'center' if lineIdx != 2 else 'left'
    ax.annotate(lineLabels[lineIdx], xy=(l.lambda0, 1), xytext=(-1, 6),
                xycoords=ax.get_xaxis_transform(), textcoords='offset points', ha=ha, fontsize='small')
    lineIdx += 1

caLabels = [
    r'Ca\textsc{ii} 3p$^6$ 4s – Ca\textsc{iii}',
    r'Ca\textsc{ii} 3p$^6$ 4p – Ca\textsc{iii}',
    r'Ca\textsc{ii} 3p$^6$ 3d – Ca\textsc{iii}']
labelIdx = 0
for i, c in enumerate(Ca.continua[::2]):
    patch = Rectangle((c.minLambda, i-0.25), c.lambdaEdge - c.minLambda, 0.5, fc=C2, alpha=0.7)
    ax.add_patch(patch)
    ax.annotate(caLabels[labelIdx], xy=(c.lambdaEdge + 1, i), va='center', fontsize='small')
    labelIdx += 1
plt.ylim(-0.25, len(Ca.continua[::2])-0.75)
plt.xlim(80, 160)

c = H.continua[0]
patch = Rectangle((c.minLambda, -0.25), c.lambdaEdge - c.minLambda, 5, fc=C1,
                  alpha=0.5, hatch='/', ec=C1, lw=0.0)
ax.add_patch(patch)
plt.axvline(c.lambdaEdge, c=C1, ls='--', alpha=0.8)
ax.annotate('← LyC', xy=(c.lambdaEdge, 1), xytext=(-5, 6),
            xycoords=ax.get_xaxis_transform(), textcoords='offset points', ha='center', fontsize='small')

# yticks = np.arange(5)
# plt.yticks(yticks, ['A', 'B', 'C', 'D', 'E'])
plt.yticks([],[])

plt.xlabel(r"$\lambda$ [nm]")
plt.tight_layout()
lFig = chRT.save_figure('CaIIOverlaps', fig, fext='.pgf')
lFig.caption = r'The overlap betwen the hydrogen Lyman lines and continuum with the Ca\,\textsc{ii} continua present in the model atom used here. Both the Ca\,\textsc{ii} 3p$^6$ 4p and 3p$^6$ 3d levels contain two sub-levels with indistinguishably different continuum edges.'
lFig.placement = 'hbtp'
\end{pycode}

\py[TimeDepRT]|chRT.get_figure('CaIIOverlaps')|
%spell-checker: enable

The hydrogen (five bound levels with H\,\textsc{ii} continuum and ten lines), helium, and calcium (five bound \Caii{} levels with \Caiii{} continuum and five lines) model atoms used in the simulations presented here are the same as those used in \Radyn{}.
All other model atoms used in the LTE background opacities are taken from the \Lw{} standard library (and have in turn been converted from  RH distribution \citep{Uitenbroek2001}).

To determine the importance of the photoionisation by the Lyman lines, each \Radyn{} simulation is reprocessed twice, once including the effects of the Lyman lines on \Caii{} (henceforth Lyman inclusive (LI)), and once without these effects (Lyman exclusive (LE)).
In both cases the effects of the Lyman continuum are included, as this is commonly considered in RHD codes, and allows for direct comparison of the LE simulation against \Radyn{}.
The simulations are performed using the CRD formalism for consistency with \Radyn{}, although the models used for the Lyman lines contain an approximation to PRD by removing radiative broadening and reducing van der Waals broadening.
This is one of the two more common approaches to approximating PRD effects in these transitions, the other being to truncate the line quadrature around ten Doppler widths from the line core.
Both of these are empirical but we favour the former in flare simulations as the narrow grid used in the latter can easily ``lose'' opacity in the moderate to high Doppler shifts that occur in flare models (Carlsson, \emph{private communication}).
PRD effects are also present in the \Caii{} lines (primarily the resonance lines, although cross-redistribution effects also affect the infra-red triplet).
The effects on these are typically less significant than those on the hydrogen Lyman lines, especially due to the high chromospheric densities that occur during flares.
We therefore do not add any approximate PRD treatments to the \Caii{} lines.
These model atoms are therefore identical between \Radyn{} and \Lw{}, and the two models differ only in their description of LTE background opacities, which in the case of the \Lw{} simulations includes helium.
By comparing these simulations it should therefore be relatively easy to disentangle the photoionisation effects we wish to study.

\subsection{The \Radyn{} simulations}

\subsection{Line Profiles}

\subsection{Radiative Losses}

\subsection{Discussions}

\section{PRD}