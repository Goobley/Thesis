\chapter{Flare Modelling}

\begin{itemize}
    \item Radiative Transfer Physics
    \item Radiation hydrodynamics
    \item Numerical approaches to RT and RHD. (combined into the previous sections)
    \item Important optical spectral lines \Ha{}, \CaLine{}; observations thereof.
    \item Inversions
\end{itemize}

{\color{Red} Convention Positive velocity -> Upflow, all plots shown with vacuum wavelengths unless stated otherwise}

\section{Introduction to Radiative Transfer}

Radiative transfer is the science of how radiation propagates through a material; the absorptions, scatterings and emission that happens therein.
Radiation is the close to the only conduit through which information can arrive from celestial bodies, and by far the most widely exploited.
It allows us to derive proxies for \emph{in situ} measurements, that cannot otherwise be obtained, due to the distances and extreme conditions being observed.
Everyone is familiar with the concept of images, which show the spatial variation of light but a lot of additional information can be gleaned by analysing it in terms of its wavelength variation and polarisation projections.
Using both of these properties is referred to as \emph{spectropolarimetry}, and \emph{spectroscopy} when only the unpolarised intensity is considered.
The most basic property to consider here is the specific intensity, commonly denoted $I(\nu, \vec{d]})$ for a particular frequency $\nu$ and direction $\vec{d}$ at a location in space with typical SI units \si{\joule\per\square\metre\per\s\per\hertz\per\steradian}.

A ray propagating through a medium, such as a neutral gas or plasma, will gain a certain amount of energy per unit length due to emission processes, whilst also losing another amount due to absorption and scattering processes. These will depend on the local parameters of the plasma as well as the direction of the ray. For a plasma where the primary interacting species are atomic, we can distinguish bound-bound and bound-free transitions. In the former a bound electron moves between two different sublevels of an atom\footnote{Here "atom" refers to either a neutral atom or an ion}, whilst in the latter the atom either absorbs sufficient energy to free a previously bound electron, or an ion loses sufficient energy to recombine with a free electron.

In addition to the obvious spontaneous emission and absorption processes, there is also a process of stimulated emission which is needed to balance the transitions. This occurs when an electron is stimulated to transition between levels by photons with the same frequency and direction as the photon produced by this transition.

In the following we will discuss how to obtain the frequency- and direction-dependent outgoing radiation given the emissivity and opacity of the plasma, and how to obtain a self-consistent radiation field and populations for the atomic species outside of the approximations of local thermodynamic equilibrium.

\section{The Formal Solution}

For a one-dimensional planar atmosphere the radiative transfer equation (RTE) can be written as
\begin{equation}
    \frac{1}{c}\frac{\partial I(\nu, \vec{d})}{\partial t} + \mu \frac{\partial I(\nu, \vec{d})}{\partial z} = \eta(\nu, \vec{d}) - \chi(\nu, \vec{d})I(\nu, \vec{d}).
\end{equation}
We consider that the light crossing time for the propagation of light on a solar scale is small compared to the time-evolution of the atmosphere and our observations and therefore ignore the time-derivative term.
Defining the source function $S(\mu, \vec{d}) = \eta(\nu, \vec{d}) / \chi(\nu, \vec{d})$, and the optical depth along a ray from the observer as the number of photon mean free paths along this segment $\tau(z, \nu, \vec{d}) = \int_z^{z_{\mathrm{obs}}} = \chi_\nu(z^\prime) / \mu\, dz^\prime$ we can write the RTE as.
\begin{equation}
    \frac{\partial I(\nu, \vec{d})}{\partial \tau(\nu, \vec{d})} = I(\nu, \vec{d}) - S(\nu, \vec{d}).
    \label{Eq:1DRte}
\end{equation}

Equation \ref{Eq:1DRte} is a first-order linear differential equation and can be solved with the integrating factor $e^{-\tau(\nu, \vec{d})}$ giving

\begin{equation}
I(\tau_0, \nu, \vec{d}) = I(\tau_1, \nu, \vec{d}) e^{-(\tau_1 - \tau_0)} + \int_{\tau_0}^{\tau_1}S(t_\nu, \nu, \vec{d})e^{-(t_\nu - \tau_0)}\, dt_\nu,
\label{Eq:IntegratedRte}
\end{equation}
for $\tau_0$ the optical depth at the observer and $\tau_1 > \tau_0$ along the line of sight.

The solution in equation \ref{Eq:IntegratedRte} prescribes nothing about the form of the source function in the atmosphere, and assumes that it varies continuously.
Whilst there are approaches such as Feautrier's \NeedRef{} that involve casting the problem as a second order differential equation we shall focus on the so-called short-characteristic method consisting of solving the RTE directly between discrete points by prescribing a functional form for its variation between these points. Due to the Feautrier method solving the problem for both an up-going and a down-going ray simultaneously, it cannot handle both Doppler shifts and overlapping lines, for these reasons, we will not discuss it further.

\subsection{Short-Characteristics Methods}\label{Sec:ShortChar}

If a functional form with an analytic integral is chosen for the variation of the source function between defined points then an atmosphere can be treated as a sum of analytic integrals. We shall consider the simplest useful functional form, a linear variation as an illustrative example.

The RTE for one slab of a plane-parallel atmosphere (in the case of outgoing radiation (i.e. $\mu > 0$)) can then be written

\begin{equation}
    I(\tau_0) = I(\tau_1) \exp(- |\tau_0 - \tau_1|) + \int_{\tau_0}^{\tau_1} S(t) \exp(-(t - \tau_0))\, dt.
    \label{Eq:ShortCharForm}
\end{equation}

Now, assuming a linear variation of $S$ with $\tau$ in this slab gives

\begin{equation}
    S(t) = S_{\tau_0} \frac{\tau_1-t}{\tau_1-\tau_0} + S_{\tau_1} \frac{t-\tau_0}{\tau_1-\tau_0},
\end{equation}

which can then be substituted into \eqref{Eq:ShortCharForm} (with $\Delta := \tau_1 - \tau_0$) giving

\begin{equation}
    I(\tau_0) = I(\tau_1) \exp(- |\tau_1 - \tau_0|) +
    \frac{\Delta - 1 + \exp(-\Delta)}{\Delta} S_{\tau_0} +
    \frac{1 - \exp(-\Delta) - \Delta\exp(-\Delta)}{\Delta} S_{\tau_1}.
\end{equation}

In atmospheres with very well resolved spatial grids, this method works quite well, however whenever the true source function has positive curvature, it overestimates intensity, and underestimates it for negative curvature. These effects can become quite significant in more sparesly sampled atmospheres.

The short characteristics method can be improved by using higher order polynomial interpolants, however these can lead to spurious ringing artifacts, negatively affecting their precision. One commonly used robust alternative is the monotonic piecewise parabolic method of \citet{Auer1994}. This method assumes a parabolic variation of the source function across local three point stencils, but limits it to the value obtained from linear interpolation if the parabolic interpolant exits the range bounded by these three points.

Other interpolating functions can be used. For example, the cubic BÃ©zier spline interpolant of \citet{DelaCruzRodriguez2013}, provides a higher order approximation in regions of smooth variation, and can be limited through the control points to prevent any ringing instability. A similar approach has been taken with the BESSER second order approach of \citet{Stepan2013}.
All of these methods can be derived analagously to the linear formal solver presented above.

\subsection{Other Formal Solvers}

\citet{Janett2018} proposes a novel approach to the formal solver,  using an optimised solver for the differing optical thickness in each slab. They show that this leads to substantial performance benefits whilst also being more numerically stable. They comment that whilst higher order formal solvers will theoretically converge better to the true result, due to the assumptions that are made in their derivation, this will only occur if the variation of the source function in relevant regions of the atmosphere is sufficiently smooth. Most inversions use fewer than 7 nodes in each atmospheric parameter, and the modern 3D RMHD simulations use relatively coarse spatial grids with large transients in atmospheric parameters that risk provoking instability in the higher order formal solvers, especially in the case of full Stokes radiative transfer.
As work continues on these higher resolution RMHD simulations an investigation into how each formal solver handles discontinuous parameters is needed.


\section{LTE vs NLTE}

With the formal solvers discussed in the previous section, and knowledge of the emissivity and opacity throughout an atmospheric model, the outgoing radiation can be computed directly. As the emissivity and opacity of the plasma depend primarily on the atomic level populations, knowledge of these is sufficient for computing the radiation.
This is the case if the plasma is in local thermodynamic equilibrium (LTE), which typically occurs if the plasma is sufficiently collisional, for example in the photosphere. The atomic populations are then described entirely by the thermodynamic properties (temperature and density) of the atmosphere and can be computed by application of the Saha-Boltzmann equation.\footnote{If the electron density is not know \textit{a priori} then an iteration scheme using the Saha-Boltzmann equation is necessary to determine consistent values of both the electron density and the atomic populations.} On a microscopic view, LTE occurs when the atomic processes are in detailed balance (i.e. for every transition there is an equivalent opposing transition).

Unfortunately, the LTE description is inadequate, as discussed by Jefferies and Thomas \NeedRef{}, and everything outside of this is termed non-LTE (NLTE). In fact, due to the detailed balance of an LTE treatment, if detailed balance applied throughout the stellar atmosphere, no radiation would be able to escape. As photons are able to escape from the upper layers of the atmosphere, there is insufficient absorption processes to balance the emission processes and these layers must be NLTE. This is particularly clear for the chromosphere and transition region where a non-monotonic temperature gradient could not arise if the atmosphere were in LTE.
Departures from an LTE description of the plasma are therefore expected when the radiative rates become comparable or larger than the collisional rates, and where the radiation field is not black-body like.
We distinguish here, and in the following, between radiative transitions (due to spontaneous emission and absorption, and stimulated emission), and collisional transitions (due to collisions between particles).

Thus for an $N$-level atom we have the total transition rate between levels $i$ and $j$ (by convention $i < j$)
\begin{equation}
    P_{ij} = R_{ij} + C_{ij},
\end{equation}
where $R_{ij}$ is the rate of radiative transitions and $C_{ij}$ is the rate of collisional transitions.
As the total population of each element must remain constant we can write the kinetic equilibrium equation (which can be derived from the Boltzmann equation)
\begin{equation}
    \frac{\partial n_l}{\partial t} + \nabla \cdot (n_l \vec{v}) = \sum_{l^\prime\neq l} (n_{l^\prime} P_{l^\prime l}) - n_l \sum_{l^\prime\neq l} P_{ll^\prime}.
    \label{Eq:KinEq}
\end{equation}

Equation \eqref{Eq:KinEq} is commonly simplified to the statistical equilibrium equation, whereby the left-hand side is set to 0. In this case we are solving for a time-independent equilibrium value of the atomic populations, whereas the full kinetic equilibrium equation requires knowledge of the historic populations.

To solve \eqref{Eq:KinEq}, we require the values of $P_{ij}$ for the atoms present in the atmosphere; the collisional rates can be determined purely from local parameters, however due to the effects of stimulated emission the radiative rates are coupled to the local radiation field, which originates from elsewhere in the atmosphere. This effect couples all layers of the atmosphere together and is the primary source of the complexity of the NLTE problem. In collisional LTE plasmas the collisional rates dominate and the Saha-Boltzmann equation holds.

To mathematically describe these effects we must first arrive at a definition of emissivity and opacity.
Spectral lines have a rest frequency $\nu_{ij}$  defined by
\begin{equation}
    \nu_{ij} = \frac{h}{\Delta E_{ji}},
\end{equation}
where $h$ is Planck's constant and $\Delta E_{ji}$ is the energy difference between levels $j$ and $i$.
Such a transition between states in a plasma with no bulk velocity is not infinitely fine, but is broadened by a number of factors such as natural broadening from uncertainty in the lifetime of the upper state, Doppler broadening due to random thermal motions in the plasma, and collisional broadening.
The net effects of these processes typically leads to spectral line profiles being modelled as a Voigt function (the convolution of Gaussians and Lorentzians). The normalised line absorption profile then describes the probability of a photon with a certain energy being absorbed by the transition.

Returning now to the radiative rates for bound-bound processes; the Einstein coefficients $A_{ji}$, $B_{ij}$, and $B_{ji}$ respectively describe the spontaneous emission, absorption, and stimulated emission processes.
The radiative rates can then be written
\begin{align}
    R_{ij} &= \oint \int B_{ij} \phi(\nu, \vec{d}) I(\nu, \vec{d})\,d\nu\,d\Omega,\\
    R_{ji} &= \oint \int \left[\left(A_{ji} + B_{ji} I(\nu, \vec{d})\right)\psi(\nu, \vec{d}) \right]\,d\nu\,d\Omega,
    \label{Eq:BbRates}
\end{align}
where $\phi$ is the line absorption profile, $\psi$ is the line emission profile, $A$ and $B$ are the Einstein coefficients for the transition, and $I(\nu, \vec{d})$ is the specific intensity at this location for a given frequency and direction.
These can be expressed similarly for bound-free transitions
\begin{align}
    R_{ij} &= \oint \int \alpha_{ij}(\nu) I(\nu, \vec{d})\,d\nu\,d\Omega,\\
    R_{ji} &= \oint \int \left[\left(I(\nu, \vec{d}) + \frac{2h\nu^3}{c^2}\right) \alpha_{ij}(\nu)n_e\Phi_{ij}(T) e^{-h\nu/k_B T} \right]\,d\nu\,d\Omega,
\end{align}
where $h$ is Planck's constant, $c$ is the speed of light, $\alpha_{ij}$ is the photoionisation cross-section, $k_B$ is Boltzmann's constant, and $n_e$ is the electron number density.
$\Phi$ is the Saha-Boltzmann equation defined such that
\begin{equation}
    n_e\Phi_{ij}(T) = \frac{n^*_i}{n^*_j} = \frac{g_i}{2g_j}\left( \frac{h^2}
    {2\pi m_e k_B T} \right)^{3/2} \exp{\left(  \frac{\Delta E_{ji}}{k_B T}\right)},
\end{equation}
where $n^*$ is the population of the species in LTE, $m_e$ is the electron mass, $\Delta E_{ji}$ is the energy difference between levels $j$ and $i$, and $g_i$ is the statistical weight of level $i$.

Following now the notation of \citet{Rybicki1992} and \citet{Uitenbroek2001} the emissivity $\eta$ and opacity $\chi$ for a transition are written
\begin{align}
    \label{Eq:Emis}
    \eta_{ij} &= n_j U_{ji}(\nu, \vec{d}), \\
    \label{Eq:Opac}
    \chi_{ij} &= n_i V_{ij}(\nu, \vec{d}) - n_j V_{ji}(\nu, \vec{d}),
\end{align}
where $n_i$ is the population density level $i$.
The $U$ and $V$ terms are defined for bound-bound and bound-free transitions as
\newlength{\WidestCase}
\settowidth{\WidestCase}{$n_e\Phi_{ij}(T)\left(\frac{2h\nu^3}{c^2}\right)e^{-h\nu/k_B T}\alpha_{ij}(\nu),$}
\begin{align}
    \label{Eq:Uji}
    U_{ji} =&
    \begin{cases}
        \frac{h\nu}{4\pi}A_{ji}\psi_{ij}(\nu, \vec{d}), & \textrm{bound-bound} \\
        n_e\Phi_{ij}(T)\left(\frac{2h\nu^3}{c^2}\right)e^{-h\nu/k_B T}\alpha_{ij}(\nu), & \textrm{bound-free},
    \end{cases}\\
%
    \label{Eq:Vij}
    V_{ij} =&
    \begin{cases}
        \makebox[\WidestCase][l]{$\frac{h\nu}{4\pi}B_{ij}\phi_{ij}(\nu, \vec{d}),$} & \textrm{bound-bound} \\
        n_e\Phi_{ij}(T)e^{-h\nu/k_B T}\alpha_{ij}(\nu), & \textrm{bound-free},
    \end{cases}\\
%
    \label{Eq:Vji}
    V_{ji} =&
    \begin{cases}
        \makebox[\WidestCase][l]{$\frac{h\nu}{4\pi}B_{ji}\psi_{ij}(\nu, \vec{d}),$} & \textrm{bound-bound} \\
        \alpha_{ij}(\nu), & \textrm{bound-free}.
    \end{cases}
\end{align}
By convention we define $U_{ij} = U_{ii} = V_{ii} = 0$ and $\chi_{ij} = -\chi_{ji}$.

In the approximation of complete redistribution (which we will return to later) we have $\phi_{ij} = \psi_{ij}$ then
\begin{align}
    R_{ij} &= B_{ij}\bar{J}_{ij} \\
    R_{ji} &= A_{ji} + B_{ji}\bar{J}_{ij},
\end{align}
where $\bar{J}_{ij}$ is the absorption profile weighted integrated mean intensity, i.e.
\begin{equation}
    \bar{J}_{ij} = \frac{1}{4\pi}\oint\int \phi_{ij}(\nu, \vec{d}) I(\nu, \vec{d})\, d\nu\, d\Omega.
\end{equation}

Where multiple atomic species are present, the total emissivity and opacity are simply the sum of the emissivity and opacity for every transition on each atom at the current frequency and direction. It is common to additionally consider scattering by processes such as Thomson scattering, in which case the source function will be written
\begin{equation}
    S(\nu, \vec{d}) = \frac{\eta_\mathrm{tot}(\nu, \vec{d}) + \sigma(\nu)J(\nu)}{\chi_\mathrm{tot}(\nu, \vec{d})},
\end{equation}
where $\sigma$ describes the frequency dependent scattering cross-section, and $J(\nu)$ is the angle-averaged intensity at a frequency.

Now we have an expression for the radiative rates in each line that can be computed numerically given the local value of the intensity, however the radiation field is not known \textit{a priori}. Clearly an iteration scheme will therefore be needed to find a stable set of populations yielding a self-consistent radiation field.

If we treat the formal solver as an operator yielding the intensity from the source function throughout the atmosphere, i.e.
\begin{equation}
    I(\nu, \vec{d}) = \Lambda_{\nu,\vec{d}}[S(\nu, \vec{d})],
    \label{Eq:LambdaOperator}
\end{equation}
then starting from an initial estimate of the atomic populations (e.g. LTE) we can compute the radiation field throughout the atmosphere and iteratively use this to update the populations by solving \eqref{Eq:KinEq}. This is known as Lambda iteration and presents woefully poor convergence in optically thick conditions as the size of the population updates stagnate long before the true NLTE populations are obtained.

The failure of Lambda iteration can be remedied by a process known as operator splitting, first introduced by \citet{Cannon1973} whereby we set
\begin{equation}
    \Lambda = \Lambda^* + (\Lambda - \Lambda^*),
\end{equation}
with $\Lambda^*$ an approximation of $\Lambda$. The iteration scheme them becomes
\begin{equation}
    I(\nu, \vec{d}) = \Lambda_{\nu, \vec{d}}^*[S(\nu, \vec{d})] + (\Lambda_{\nu, \vec{d}} - \Lambda_{\nu, \vec{d}}^*)[S^{\dagger}(\nu, \vec{d})],
    \label{Eq:Ali}
\end{equation}
where $\dagger$ identifies values from the previous iteration. This method is termed accelerated Lambda iteration (ALI), and can be shown to accelerate convergence by significantly amplifying the size of the corrections at large optical depths, for an appropriately chosen $\Lambda^*$.
From \eqref{Eq:Ali} we can see that it is necessary to invert $\Lambda^*$ to obtain the updated value of $S$ (on which $I$) is also dependent. For a two-level atom this is discussed at length in Chapters 12 and 13 of \citet{Hubeny2014}.
The full coupling of these terms in the multi-level NLTE problem will be made explicit in a following section when the MALI methods are presented; for now it is clear that the source function depends on the emissivity and opacity of each species, which in turn are controlled by the atomic populations, which are affected by the local radiation field (see \eqref{Eq:BbRates}).

A good choice for $\Lambda^*$ is not immediately evident, as it should be cheap to construct and invert, whilst providing a good approximation of $\Lambda$. \citet{Scharmer1981} presented an approximate operator that fits these criteria and showed its congruency with the core-saturation approach of Rybicki \NeedRef{} (where the net rates in the line core and wing are treated separately to precondition the net radiative rates by removing the large proportion of photons that are emitted in the wing and immediately reabsorbed).

\citet{Olson1986} proposed the use of the diagonal of the true $\Lambda$ operator as an approximate operator, and showed that this is close to optimal, and is clearly trivial to invert (as it is a scalar). Now, the diagonal of $\Lambda$ is easy to obtain by setting a test source function $\mathcal{S}=\delta_{dd^\prime}$ (where $\delta$ is the Kronecker delta) and computing
\begin{equation}
    \Lambda^* = \Lambda[\mathcal{S}].
\end{equation}
Taking the example of the linear short characteristic formal solver presented in Sec.~\ref{Sec:ShortChar} and substituting this definition of $\mathcal{S}$ we obtain
\begin{equation}
    \Lambda^*_{\nu, \vec{d}} = \frac{\Delta - 1 + \exp(-\Delta)}{\Delta}.
\end{equation}
The approximate operator can be computed analagously for other formal solvers.

\section{Solving the multilevel NLTE problem}

Starting from the radiative transfer equation \eqref{Eq:1DRte} and the kinetic equilibrium equation \eqref{Eq:KinEq} we can construct a framework with which to solve the multilevel NLTE problem. We follow the approach of \citet{Rybicki1992} and \citet{Uitenbroek2001}, and present the problem in statistical equilibrium, although it generalises directly to non-zero left-hand sides on \eqref{Eq:KinEq}.

Substituting \eqref{Eq:LambdaOperator} into \eqref{Eq:KinEq}, and expanding the radiative rates gives
\begin{equation}
\begin{aligned}
   &\sum_{l^\prime\neq l} (n_{l^\prime}C_{l^\prime l}) +
   \sum_{l^\prime\neq l} \oint \int \frac{1}{h\nu} n_{l^\prime} (U^\dagger_{l^\prime l} + V^\dagger_{l^\prime l} I(\nu, \vec{d}))\, d\nu\, d\Omega\\
   -
   n_l &\sum_{l^\prime\neq l} C_{l l^\prime} -
   n_l \sum_{l^\prime\neq l} \oint \int \frac{1}{h\nu} (U^\dagger_{l l^\prime} + V^\dagger_{l l^\prime} I(\nu, \vec{d}))\, d\nu\, d\Omega
   = 0.
   \label{Eq:StatEqExpanded}
\end{aligned}
\end{equation}
$U$ and $V$ are marked with daggers despite their constant appear in the CRD case, as this will be needed when discussing partial frequency redistribution later.
\citet{Rybicki1992} defined a new operator $\Psi$ such that
\begin{equation}
    \Psi_{\nu, \vec{d}}[y] = \Lambda_{\nu, \vec{d}}[(\chi^\dagger)^{-1}y]
\end{equation}
These two operators are equivalent for a converged solution as $\chi^\dagger = \chi$.

The operator splitting technique can again be applied here. We then have
\begin{equation}
    I(\nu, \vec{d}) = \Psi^*[\eta(\nu, \vec{d})] + (\Psi - \Psi^*)[\eta^\dagger(\nu, \vec{d})],
\end{equation}
and then considering the effects on one atom, under the assumption that background emissivity and opacity do not change during an iteration
\begin{equation}
    I(\nu, \vec{d}) = I^\dagger(\nu, \vec{d})
                    - \sum_j\sum_{i<j}\Psi^*[n^\dagger_j U^\dagger_{ji}]
                    + \sum_j\sum_{i<j}\Psi^*[n_j U^\dagger_{ji}].
\end{equation}

The first two terms of this expression are often termed $I^\mathrm{eff}$ and in the case of a diagonal $\Psi^*$ operator this represents the non-local contribution to the radiation field from the current atom, and the contribution from all other species.

We can write \eqref{Eq:StatEqExpanded} as
\begin{equation}
    \Gamma \vec{n} = 0,
    \label{Eq:StatEqMatVec}
\end{equation}
where $\Gamma$ is a matrix consisting of the sum of $\Gamma^R$ due to the radiative contributions, and $\Gamma^C$ from the collisional contributions. $\vec{n}$ is the vector of the current level populations for the species at this point in the atmosphere.
We can then write
\begin{align}
\begin{split}\label{Eq:GammaR}
    \Gamma^R_{ll^\prime} = \oint \int \frac{1}{h\nu} \bigg( U^\dagger_{l^\prime l} + V^\dagger_{l^\prime l}I_{\nu, \vec{d}}^\mathrm{eff} -
    \left(\sum_{m\neq l}\chi^\dagger_{lm}\right) \Psi^*_{\nu, \vec{d}} \left[ \sum_p U^\dagger_{l^\prime p} \right] \bigg)\, d\nu\,d\Omega
\end{split}
\end{align}
for $l\neq l^\prime$. The problem is now represented by a system of linear equations. Due to the necessity of total number conservation each column of $\Gamma$ must be 0, which allows us to compute the diagonal terms as
\begin{equation}
    \Gamma_{ll} = -\sum_{m\neq l} \Gamma_{ml}.
\end{equation}

Iterating the populations through \eqref{Eq:StatEqMatVec} with interleaved formal solutions gives us a reliable and rapidly converging method for solving the multilevel NLTE problem with multiple atoms and overlapping transitions as used in the \Lw{} framework. More detail on the implementation are provided in the associated technical report \NeedRef{} and in the documentation \NeedRef{}.

\section{Time-Dependent Population Updates}

As discussed previously an update to the populations solving for statistical equilibrium can be phrased as $\Gamma \vec{n} = \vec{0}$. A variant of this method can also be applied to the time-dependent form of the kinetic equilibrium equations. We will not directly treat the advection term of equation \eqref{Eq:KinEq}, as this requires consideration of hydrodynamic effects and the discretisation schemes used therein (due to the large gradients of these populations that occur in the solar atmosphere).
We can, however, discretise $\partial n / \partial t = \Gamma \vec{n}$ as
\begin{equation}
    \label{Eq:ThetaDisc}
    \frac{\vec{n}^{t+1} - \vec{n}^t}{\Delta t} = \theta \Gamma^{t+1} \vec{n}^{t+1} + (1-\theta)\Gamma^{t} \vec{n}^{t},
\end{equation}
where $\theta$ indicates the degree of implicitness, the $t$ and $t+1$ indices indicate the start and end of the timestep being integreated respectively, and $\Delta t$ the duration of the timestep.
$\vec{n}^{t+1}$ can then be found by rewriting \eqref{Eq:ThetaDisc} as
\begin{equation}
    \label{Eq:TimeDepSystem}
    (\mathbb{I} - \theta\Delta t \Gamma^{t+1}) \vec{n}^{t+1} = (1-\theta)\Delta t \Gamma^{t}\vec{n}^{t} + \vec{n}^{t},
\end{equation}
with $\mathbb{I}$ the identity matrix, and iterating until $\vec{n}^{t+1}$ converges, for a new evaluation of $\Gamma^{t+1}$ at each iterate.

\section{Collisional Rates}

There are many collisional processes by which electrons can transition between levels in a plasma, including ionisation and recombination processes. These include excitation of ions by electrons, ionisation and excitation of neutral by electrons, excitation by protons and neutral hydrogen, as well as charge exchange with these species. There are other more advanced formulations too. Typically these are all empirical functional fits from laboratory and observational data, and are simply provided in a tabulated form. They are assumed to only depend on local plasma properties, such as the temperature, total particle density and electron density.

\NeedRef{}

\section{Partial Frequency Redistribution}

Most solar spectral lines form in regions where complete frequency redistribution (CRD) holds. That is to say that the plasma is sufficiently collisional that elastic collisions redistribute electrons across all sub-states of an energy level prior to emission. In this case the emission frequency of a photon is not correlated with the frequency of the photon absorbed to excite the atom into this state i.e. photons are completely redistributed in frequency and the line emission and absorption profiles are equal. In lower density regions with strong (typicaly resonance) lines, where radiative effects dominate over collisional effects, there is said to be a natural population of a certain level; a population where the emission frequency is correlated to the absorption frequeyncy, and has not been redistributed by collisions \citep{Hubeny2014}.
In this case the emission and absorption profiles for the line differ and this coherent scattering must be treated explicitly. This imposes substantial computational effort, but we will briefly describe the key points of the process, and how it fits into MALI following \citet{Uitenbroek2001} and \citet{Hubeny2014}.

We can define the emission profile coefficient $\rho_{ij} = \psi_{ij} / \phi_{ij}$, at which point all $U$ and $V$ terms can be rewritten in terms of $\rho$ and $\phi$, and $\dagger$ on these terms refers to the value of $\rho_{ij}$ evaluated at the previous iterate (analagous to $n^\dagger$).

From this definition of $\rho$, under the assumptions of a line with an infinitely sharp lower level and broadened upper level, and the validity of PRD being in the atomic frame being approximated by PRD in the observer's frame \citep{Uitenbroek2001}, following \citet{Hubeny2014} we then have
\begin{align}
\begin{split}
    \rho_{ij}(\nu, \vec{d}) = 1 + &\gamma\frac{\sum_{l < j}n_j B_{lj}}{n_j P_j} \oint\frac{1}{4\pi}\int I(\nu^\prime, \vec{d}^\prime) \\ &\cdot \left[ \frac{R^{II}_{lji}(\nu^\prime, \vec{d}^\prime; \nu, \vec{d})}{\phi_{ij}(\nu, \vec{d})} - \phi_{lj}(\nu^\prime, \vec{d}) \right]\,d\nu^\prime\,d\Omega^\prime,
\end{split}
\end{align}

where $R^{II}$ is the generalised redistibution function for transitions of this kind \citep{Hubeny1982}, and $\gamma$ is the branching ratio, or coherency fraction.
The summation over $l$ and $lji$ subscript on $R^{II}$ describe the scattering process.
When ignoring cross-redistribution (Raman scattering), we have $l=i$, and the summation is replaced by a single term, as we are only considering resonance scattering within the line $i\rightarrow j$.

The coherency fraction $\gamma$ describes the normalised probability of a photons being re-emitted from the same sublevel of energy level $j$ before an elastic collision that will redistribute it across sublevels, provided that it is re-emitted at all.
This is then given by
\begin{equation}
    \gamma = \frac{P_j}{P_j + Q_j},
\end{equation}
where $P_j$ is the total rate of transitions out of level $j$ (depopulation rate), and $Q_j$ is the total rate of elastic collisions affecting this level.

Defining $g_{II}(\nu, \nu^\prime) = R^{II}(\nu, \nu^\prime)/\phi_{ij}(\nu^\prime)$, which is normalised such that
\begin{equation}
    \label{Eq:gIINorm}
    \frac{1}{4\pi}\oint\int g_{II}(\nu, \nu^\prime) \,d\nu^\prime\,d\Omega= 1,
\end{equation}
as per \citet{Gouttebroze1986} and \citet{Uitenbroek1989} wherein fast approximations to this function are derived, and ignoring cross-redistribution we then have
\begin{align}
\begin{split}
    \label{Eq:RhoPrd}
    \rho_{ij}(\nu, \vec{d}) = 1 + & \gamma \frac{n_i B_{ij}}{n_j P_j} \oint \frac{1}{4\pi} \int I(\nu^\prime, \vec{d}^\prime) \\ & \cdot\left[ g_{II}(\nu, \nu^\prime) - \phi_{ij}(\nu^\prime, \vec{d}) \right]\,d\Omega^\prime\,d\nu^\prime.
\end{split}
\end{align}

Ignoring bulk plasma flows, the integrals over angle and frequency can then be split, providing an angle-averaged form of $\rho$ that is much easier to compute. The hybrid PRD method of \citet{Leenaarts2012} provides an approximate solution to the angle-dependent PRD problem with bulk flows, by interpolating the radiation field to the rest frame of the plasma where this simpler form approximately holds.

{\color{Red} Do we need to discuss time-dependence here? Yes.}


\section{Radiation hydrodynamics}

In our discussion of radiative transfer thus far we have treated the thermodynamic structure of the atmosphere as something constant, however given the short timescales flares evolve over, we know that this is a poor approximation.

It is common to treat a semi-ionised plasma as a single compressible fluid, obeying the equations of hydrodynamics. The influence of the magnetic field can also be included, at which point the equations of magnetohydrodynamics (MHD) are used to describe the motion of the fluid.
Due to the complexity, and resultant numerical difficulties in investigating the widely varying spatial scales that occur in flares with a three-dimensional MHD treatment, it is common to use one-dimensional field-aligned hydrodynamic code.
The assumption here is that as most observed fluid motions in a flare are along the magnetic field lines, then a single flaring loop can be approximated by a quasi-one-dimensional simulation describing the movement of a fluid through a tube, and the propagation of energy through this medium.

This gas dynamic system can be described by

\begin{equation}
    \begin{aligned}
    \frac{\partial \rho}{\partial t} + \frac{\partial \rho v}{\partial z} &= 0\\
    \frac{\partial \rho v}{\partial t} + \frac{\partial \rho v^2}{\partial z} - \rho g + \frac{\partial P}{\partial z} - \frac{\partial}{\partial z}\left(\mu \frac{\partial v}{\partial z}\right) &= 0\\
    \frac{\partial E}{\partial t} + \frac{\partial}{\partial z}\left( Ev + Pv - \kappa\frac{\partial T}{\partial z} \right)+ \mu\frac{\partial v^2}{\partial z} -\rho v g + L - S &= 0,
    \end{aligned}\label{Eq:RhdEquations}
\end{equation}

where $\rho$ is the mass density of the gas, $v$ is the bulk velocity, $z$ is the spatial coordinate, $g$ is the local graviational acceleration, $P$ is the pressure, $\mu$ is the coefficient of dynamic viscoisty, $L$ is the radiative loss term, and $S$ is all additional energy source terms, from radiative transfer and atmospheric heating. In these models the plasma is typically assumed to behave as an ideal gas, and therefore uses the equation of state
$P = n_{\mathrm{tot}} k_B T$, where $n_{\mathrm{tot}}$ is the total particle number density, $k_B$ is Boltzmann's constant, and $T$ is the plasma temperature. Additionally, $\kappa=\kappa_0 T^{5/2}$ is the coefficient of heat conduction, and from \citet{Spitzer1953} for a fully ionised hydrogen plasma $\kappa_0 = \SI{1e-6}{\erg\per\cm\per\s\per\kelvin\tothe{7/2}}$.
This conduction term requires careful treatment as the previous expression can clearly be made arbitrarily large and does not take into account the fundamental free-streaming limit (all electrons travelling in the same direction at the thermal speed). This term therefore has to be limited to not exceed physical constraints, RADYN, for example, uses the method of \citet{FISHER1985}, based on the analysis of Smith and Auer 1980 \NeedRef{} that suggests limiting the conductive flux to one-sixth of the free-streaming limit.

All of the quasi-one dimensional codes solve a variant the RHD equations in \eqref{Eq:RhdEquations}. The first of these described mass continuity, the second conservation of momentum, and the third conservation of energy. The nuance typically occurs in ensuring that all terms are solved in a self-consistent fashion and the treatment of the optically thick radiation source and sink terms appearing in the energy equation.

The first generation of hydrodynamic flare models \citet{Nagai1980,Mariska1982,McClymont1983} focused on capturing the gas dynamics of the flaring event, using simplified radiative treatment. These early models were much more limited in general due to computational constraints. \citet{Nagai1980} and \citet{Mariska1982} both employ optically thin losses with ad hoc corrections to avoid over-cooling the lower atmosphere. \citet{McClymont1983} employ an escape probability formalism for determining the radiative rates of hydrogen, which is a faster, less precise method than the previously described MALI approach. Escape probability methods are also unable to take radiative backwarming into account -- where radiation produced higher in the atmosphere is absorbed at a lower point -- which can be an important factor for solar optical transitions.

The current generation of RHD codes consists of RADYN \citep{Carlsson1992,Carlsson1995,Carlsson1999, Allred2015}, FLARIX \citep{Varady2010,Heinzel2015}, and HYDRAD \citep{Bradshaw2013}. RADYN and FLARIX both apply detailed treatment of the radiative losses for certain chromospheric transitions, whilst HYDRAD uses some escape probability-like approximations for these (Sollum \NeedRef{}).
HYDRAD originally aimed more at the investigation on non-equilibrium radiative losses in the corona, with less focus on the chromosphere than the other two, however, recent development has also moved in the direction of an improved chromospheric treatment.

RADYN is derived from the MULTI RT code \NeedRef{}, and applies the linearisation approach described therein to the entire RHD system, ensuring the self-consistency of all terms. The equations of RHD are solved in an implicit linearised form by Newton-Raphson iteration on the dynamic grid of \citet{Dorfi1987}.
RADYN was originally constructed to investigate the effects of waves propagating through the chromosphere, but was extended by \NeedRef{} to perform some of the earliest simulations of the dynamic flares with detailed radiation treatment, in a self-consistent fashion. The code has since been developed further to include improved energy transport treatments, primarily focusing on beam energy deposition \citep{Allred2005, Allred2015}.


FLARIX, on the other hand consists primarily of three separate modules. The hydrodynamics is solved by a variant of the NRL Solar Flux Tube Model described in \citet{Mariska1982,Mariska1989}, extended with a MALI module (considering non-overlapping lines with constant background continuum as described in \citet{Rybicki1991}) for detailed radiation transfer, and a test-particle code for determining heating and electron deposition \NeedRef{}.

RADYN and FLARIX have recently been tested against each other and shown to provide remarkable agreement, despite their different heritage \NeedRef{}.

{\color{Red} Expand. RADYN was ``converted'' for flares by Abbett \& Hawley. Need to limit conduction}

\section{An eye to the future: Radiative Magnetohydrodynamics}

Much scientific effort is being invested into the creation of three-dimensional radiative MHD models, which aim to accurately describe all of the physics of a flaring system through the use of supercomputers. The two leading codes are \textit{Bifrost} \citep{Gudiksen2011}, and MURaM \citep{Rempel2009,Rempel2016}. MURaM was originally focused on photospheric magnetoconvection, but has been extended into the corona. It adopts a grey radiative transfer technique that treats all outgoing radiation as a single bin, but has successfully demonstrated the ability to drive self-consistent flare-like eruptions from time-dependent photospheric magnetograms \NeedRef{}.
\textit{Bifrost} is more focused on a detailed chromospheric treatment, and currently uses multi-group opacities and the Sollum model for hydrogen \NeedRef{} to better treat the radiative losses from this region.
Currently, neither code simultaneously handle the raw energy injection investigated in the field-aligned flare models on an equivalent spatial resolution, or providing equivalent diagnostics, but this is an area of very active development.

\section{Simulations of Solar Flares}

The previously discussed modern RHD codes are designed to simulate the response of a tube of initially quiet solar atmosphere to heating, typically presumed to be due to a beam of energetic electrons precipitating from the corona.

The direct effects of these electrons must also be considered, as their flux is sufficiently large that their collisions with particles in the lower atmosphere can substantially change the distribution of these particles, exciting and ionising them.
The evolution of the atmosphere will also affect how and where it interacts with these precipitating electrons, coupling an additional problem to the extant RHD system.

There are different methods of solving this problem, the simplest of which is the analytic solution of \citet{Emslie1978} which provides a simple analytic solution to beam energy deposition along the column under the assumption that all electron energy is lost due to Coulomb collisions with the plasma acting as a cold target.
This is a useful approximate treatment, however effects such as relativistic effects on high energy electrons, return current (heating the corona), and magnetic mirroring are all important here. RADYN and FLARIX both include more advanced treatments including these effects; FLARIX uses a test-particle module, whereas RADYN solves the Fokker-Planck equation \NeedRef{}, but both also include the option to use the simpler Emslie formulation.

These simulations of flares therefore allow us to predict the line and continuum emission from the time-evolution of a starting atmosphere. These detailed results can be compared against observations, and have provided significant insight into chromospheric properties (e.g. \citet{Kuridze2015,Kowalski2017,Simoes2017}). The manual forward-fitting process involved in attempting to reproduce these observations with simulations is both time-consuming and difficult, something we will address later in Chapter \ref{Chap:Radynversion}.


\section{Important Optical Spectral Lines}

Ground-based telescopes can be much larger and more complex than their space-based counterparts for an equivalent budget. In exchange for this they can only observe in limited bands (due to atmospheric effects), and suffer from the effects of atmospheric turbulence. With these telescopes we therefore focus on optical and near-infrared lines, which are the least affected.

We shall focus on two of the strongest optical lines, \Ha{} at \SI{656.3}{\nano\m}, and \CaLine{}. Both of these lines form in the chromosphere (albeit at different altitudes), and carry large amounts of information pertaining to the details of their formation.

\subsection{CRISP observations of these}
\subsection{DKIST, \& the future.}